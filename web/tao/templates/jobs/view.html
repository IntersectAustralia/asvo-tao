{% extends '_base.html' %}

{% load url from future %}
{% load staticfiles %}
{% load bootstrap_tags %}
{% load assets %}

{% block subtitle %}Viewing Job{% endblock subtitle %}

{% block extrajs %}
    <link rel="stylesheet" href="{% static 'css/jquery-ui/themes/base/jquery-ui.css' %}" />
    <script src="{% static 'js/jquery-ui-1.10.1.custom.min.js' %}"></script>
    <script src="{% static 'js/jquery.formset.min.js' %}"></script>
    <script src="{% static 'js/jquery.validate.js' %}"></script>
    <script type='text/javascript' src="{% static 'js/knockout-2.3.0.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/TwoSidedSelectWidget.js' %}"></script>
    <!-- <script type="text/javascript" src="{% static 'js/light_cone.js' %}"></script> -->
    <script type="text/javascript" src="{% static 'js/catalogue.js' %}"></script>
{% endblock extrajs %}

{%  comment %}
INGREDIENT #5: use forms here .summary view to render the summary here; but it requires JavaScript AND
the forms being hidden and all.
{% endcomment %}

{% block content %}
    <div>
        <h1>Viewing Job {{ job.id }}</h1>
        <div>
{#        Maybe need this for QA testing at some stage #}
{#            <div>#}
{#                <strong>Parameters</strong>#}
{#                <span>#}
{#                    {{ job.parameters|linebreaks }}#}
{#                </span>#}
{#            </div>#}

                <strong>Optional Description:</strong>
            <div id="inlineedit">
                <div contenteditable id="id-job_description" data-name="job-description">
                    <em>{{ job.description }} </em>
                </div>
                <div id="savecancel">
                  <div id="id-save_edit" class="btn" type="button" value="Save">&#10003;</div>
                  <div id="id-cancel_edit" class="btn" type="button" value="Cancel">X</div>
                </div>
           </div>
            <div>
                <strong>Download</strong>

                <ul id='id_completed_jobs'>
                    <li><a id='id_download_summary_txt' href="{% url 'get_summary_txt_file' job.id %}">summary.txt</a></li>
                    {% if job.is_completed %}
                        {% for file in job.files %}
                            <li>
                            {% if file.can_be_downloaded %}
                                <a href="{% url 'get_file' job.id file.file_name %}">
                                    {{ file.file_name }}
                                </a> ({{ file.get_file_size }})
                            {% else %}
                                {{ file.file_name }} ({{file.get_file_size }}. File size exceeds download limit.)
                            {% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                    {% if job.can_download_zip_file %}
                        <a id='id_download_as_zip' href="{% url 'get_zip_file' job.id %}">
                            Download zip file
                        </a>
                    {% else %}
                        (Zip file exceeds maximum download size.)
                    {% endif %}
                {% else %}
                    <p>This job has not completed (and hence has no output).</p>
                    </ul>
                {% endif %}
            </div>
            <div>
                <strong>Status</strong>
                <p>{{ job.status }}</p>
                {% if job.is_error %}
                    <pre>
                    {{ job.error_message|linebreaks  }}
                    </pre>
                {% endif %}
            </div>
            <div>
                <strong>Summary</strong>
            </div>
            <div class="row-fluid" style="display: none;">
                {% for form in forms %}
                    <form action="" method="">
                        {% include form.EDIT_TEMPLATE %}
                    </form>
                {% endfor %}
            </div>
            <div class="job_view">
                {% for form in forms %}
                    {% include form.SUMMARY_TEMPLATE %}
                {% endfor %}
            </div>
        </div>
    </div>
    <form id="csrf_token">
    {% csrf_token %}
    <input type="hidden" id="job_id" value="{{ job.id }}" />
    </form>

    <script>
      $("#inlineedit").click(function() {
        $('#savecancel').show();
      });
      $("#id-job_description").focusout(function() {
        $('#savecancel').hide();
      });
    </script>
{% endblock content %}
